from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext, ConversationHandler
import json
import base64
import asyncio
import websockets
from app.core.app_core_config import Config  # ØªÙ†Ø¸ÛŒÙ…Ø§Øª

# Ù…Ø±Ø§Ø­Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡
CURRENCY, NETWORK, WALLET = range(3)

# WebSocket ØªÙ†Ø¸ÛŒÙ…Ø§Øª
WS_URL = "wss://your-websocket-server.com"  # Ø¢Ø¯Ø±Ø³ WebSocket Ø¬Ø¯ÛŒØ¯Øª

async def send_via_websocket(data: dict):
    async with websockets.connect(WS_URL) as websocket:
        await websocket.send(json.dumps(data))
        response = await websocket.recv()
        return json.loads(response)

def start_payment(update: Update, context: CallbackContext) -> int:
    deeplink_data = context.args[0] if context.args else None
    if deeplink_data and deeplink_data.startswith("pay_"):
        encoded_data = deeplink_data.split("_")[1]
        decoded_data = json.loads(base64.b64decode(encoded_data).decode())
        context.user_data["package"] = decoded_data

    # Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø²
    keyboard = [
        [InlineKeyboardButton("USDT", callback_data="USDT")],
        [InlineKeyboardButton("TON", callback_data="TON")],
    ]
    update.message.reply_text(
        "ğŸ”¹ Ù„Ø·ÙØ§ Ø§Ø±Ø² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=InlineKeyboardMarkup(keyboard),
    )
    return CURRENCY

def select_network(update: Update, context: CallbackContext) -> int:
    context.user_data["currency"] = update.callback_query.data
    networks = (
        ["Ethereum", "BSC", "TON"]
        if context.user_data["currency"] == "USDT"
        else ["TON"]
    )

    keyboard = [[InlineKeyboardButton(n, callback_data=n) for n in networks]]
    update.callback_query.edit_message_text(
        f'ğŸŒ Ø´Ø¨Ú©Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ {context.user_data["currency"]} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:',
        reply_markup=InlineKeyboardMarkup(keyboard),
    )
    return NETWORK

def get_wallet(update: Update, context: CallbackContext) -> int:
    context.user_data["network"] = update.callback_query.data
    update.callback_query.edit_message_text("ğŸ“¨ Ù„Ø·ÙØ§ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return WALLET

def process_payment(update: Update, context: CallbackContext) -> int:
    context.user_data["wallet"] = update.message.text

    # Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ WebSocket
    payload = {
        "action": "start_payment",
        "user_id": context.user_data["package"]["userId"],
        "amount": context.user_data["package"]["usdPrice"],
        "currency": context.user_data["currency"],
        "network": context.user_data["network"],
        "wallet": context.user_data["wallet"],
    }

    # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ WebSocket
    asyncio.create_task(handle_ws(update, payload))

    update.message.reply_text(
        "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…... Ù„Ø·ÙØ§Ù‹ Ø´Ú©ÛŒØ¨Ø§ Ø¨Ø§Ø´ÛŒØ¯."
    )

    return ConversationHandler.END

async def handle_ws(update: Update, payload: dict):
    try:
        response = await send_via_websocket(payload)
        if response.get("status") == "success":
            await update.message.reply_text(
                f'âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ {response["tx_hash"]} Ø«Ø¨Øª Ø´Ø¯!'
            )
        else:
            await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª!")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„: {str(e)}")
